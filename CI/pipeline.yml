# https://aka.ms/yaml

trigger:
  branches:
    include:
    - '*'
    # - master
    # - releases/*
  paths:
    exclude:
    - README.md
    - CHANGELOG.md

jobs:
  - job: 'Windows powershell all options'
    pool:
      vmImage: 'windows-latest'
    steps:
    - powershell: 'Install-Module -Name Pester -Force -SkipPublisherCheck'
      displayName: 'Update Modules'
    - powershell: './CI/PS-CI.ps1'
      displayName: 'Check Build Check Pack Test'
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: '**/TestResults*.xml'
        failTaskOnFailedTests: true
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/ImportExcel'
        artifact: 'ImportExcel'

  - job: 'PowerShell Core on Windows Build and Pester only'
    pool:
      vmImage: 'windows-latest'
    steps:
    - pwsh: 'Install-Module -Name Pester -Force'
      displayName: 'Update Pester'
    - pwsh: .\ci\PS-CI.ps1 -SkipPreChecks -SkipHelp -SkipPostChecks'
      displayName: 'Install and Test'
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: '**/TestResults*.xml'
        failTaskOnFailedTests: true

  - job: 'Ubuntu Build and Pester Only'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - powershell: 'Install-Module -Name Pester -Force'
      displayName: 'Update Pester'
    - powershell: '.\ci\PS-CI.ps1 -SkipPreChecks -SkipHelp -SkipPostChecks   '
      displayName: 'Install and Test'
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: '**/TestResults*.xml'
        failTaskOnFailedTests: true

  - job: 'macOS Build and Pester Only'
    pool:
      vmImage: 'macOS-latest'
    steps:
    - script: brew install mono-libgdiplus
      displayName: 'Install mono-libgdiplus'
    - powershell: 'Install-Module -Name Pester -Force'
      displayName: 'Update Pester'
    - powershell: './CI/CI.ps1 -Test'
      displayName: 'Install and Test'
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: '**/TestResults*.xml'
        failTaskOnFailedTests: true
